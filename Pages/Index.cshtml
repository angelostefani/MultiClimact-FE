@page
@model IndexModel
@{
    ViewData["Title"] = Localizer["title"];
    List<string> Maps = new List<string> { "OpenStreetMap - EPSG:3857", "Google Normal - EPSG:3857", "Google Satellite - EPSG:3857", "Google Hybrid - EPSG:3857", "OpenTopoMap", "Sentinel-2 cloudless", "Metacarta - EPSG:4326", "geoSdi - EPSG:4326", "geoSdi No Map - EPSG:4326" };
}

@if (!(User.Identity is null) && !User.Identity.IsAuthenticated)
{
    Response.Redirect("Identity/Account/Login");
}
else
{
    <!DOCTYPE html>
    <html>
    <head>
        <title>OpenLayers Map</title>
        <link rel="stylesheet" href="~/lib/openlayers/ol.css" type="text/css" />
        <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />

        <script src="~/lib/jquery/dist/jquery.min.js"></script>
        <script src="~/lib/openlayers/dist/ol.js"></script>

    </head>
    <body>
        <!-- Spazio tra il menù del Layout e il menù della pagina-->
        <div id="space" style="width: 100%; height: 10vh;"></div>

        <!-- Menù della pagina-->
        <nav class="navbar navbar-expand-sm navbar-dark" style=" background-color: #185ba1;">
            <div class="container-fluid">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Home</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Natural Events</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item">Earthquakes</a></li>
                            <li><a class="dropdown-item">Heat Waves</a></li>
                            <li><a class="dropdown-item">Precipitations</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Risk Analysis</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item">Damages</a></li>
                            <li><a class="dropdown-item">Resilience</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Simulation</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item">Earthquake</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">UAS</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item">Video from UAS</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Settings</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Maps</a>
                        <ul class="dropdown-menu">
                            @foreach (var mappa in Maps)
                            {
                                <li><a class="dropdown-item" href="#" onclick="changeMap('@mappa.Trim()')">@mappa.Trim()</a></li>
                            }
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Mappa -->
        <div id="map" style="width: 100%; height: 100vh; cursor: pointer; overflow: hidden; display: block;"></div>

        <!-- Barra di ricerca indirizzi -->
        <div class="search-bar">
            <div class="input-group">
                <input id="addressInput" placeholder="Cerca un indirizzo" type="text" class="form-control" style="text-overflow: ellipsis;">
            </div>
            <div id="suggestions" class="list-group mt-1" style="display: none;"></div>
        </div>

        <!-- Coordinate del mouse -->
        <div id="mouseCoordinates"></div>

        <script type="text/javascript">
            $(document).ready(function () {
                initMap();
            });

            // Funzione per cercare gli indirizzi e visualizzare i suggerimenti
            $('#addressInput').on('input', function () {
                var address = $(this).val();
                setTimeout(function () {
                    var url = 'https://nominatim.openstreetmap.org/search?q=' + address + '&format=json&addressdetails=1&limit=5';

                    $.getJSON(url, function (data) {
                        $('#suggestions').empty();
                        if (data && data.length > 0) {
                            $('#suggestions').show();
                            $.each(data, function (i, item) {
                                $('#suggestions').append('<a href="#" class="list-group-item list-group-item-action">' + item.display_name + '</a>');
                            });
                        } else {
                            $('#suggestions').hide();
                        }
                    });
                }, 2000); // 2000 milliseconds delay
            });

            // Funzione per zoomare sulla posizione selezionata dall'utente
            $('#suggestions').on('click', 'a', function (e) {
                e.preventDefault();
                var address = $(this).text();
                var url = 'https://nominatim.openstreetmap.org/search?q=' + address + '&format=json&addressdetails=1&limit=1';

                $.getJSON(url, function (data) {
                    if (data && data.length > 0) {
                        var lon = parseFloat(data[0].lon);
                        var lat = parseFloat(data[0].lat);
                        map.getView().setCenter(ol.proj.fromLonLat([lon, lat]));
                        map.getView().setZoom(15);
                        $('#suggestions').hide();
                    }
                });
            });
        </script>
    </body>
    </html>
}