@page
@model IndexModel
@{
    ViewData["Title"] = Localizer["title"];
    List<string> Maps = new List<string> { "OpenStreetMap - EPSG:3857", "Google Normal - EPSG:3857", "Google Satellite - EPSG:3857", "Google Hybrid - EPSG:3857", "OpenTopoMap", "Sentinel-2 cloudless", "Metacarta - EPSG:4326", "geoSdi - EPSG:4326", "geoSdi No Map - EPSG:4326" };
}

@if (!(User.Identity is null) && !User.Identity.IsAuthenticated)
{
    Response.Redirect("Identity/Account/Login");
}
else
{
    <!DOCTYPE html>
    <html>
    <head>
        <title>OpenLayers Map</title>
        <link rel="stylesheet" href="~/lib/openlayers/ol.css" type="text/css" />
        <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />

        <script src="~/lib/jquery/dist/jquery.min.js"></script>
        <script src="~/lib/openlayers/dist/ol.js"></script>

    </head>
    <body>
        <!-- Spazio tra il menù del Layout e il menù della pagina-->
        <div id="space" style="width: 100%; height: 10vh;"></div>

        <!-- Menù della pagina-->
        <nav class="navbar navbar-expand-sm navbar-dark" style=" background-color: #185ba1;">
            <div class="container-fluid">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Home</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Natural Events</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="updateBreadcrumb('Natural Events', 'Earthquakes')">Earthquakes</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updateBreadcrumb('Natural Events', 'Heat Waves')">Heat Waves</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updateBreadcrumb('Natural Events', 'Precipitations')">Precipitations</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Risk Analysis</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="updateTabs('Damages'); updateBreadcrumb('Risk Analysis', 'Damages')">Damages</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updateTabs('Resilience'); updateBreadcrumb('Risk Analysis', 'Resilience')">Resilience</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Simulation</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="updateTabs('Earthquake'); updateBreadcrumb('Simulation', 'Earthquake')">Earthquake</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">UAS</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="updateTabs('UAS'); updateBreadcrumb('UAS', 'Video from UAS')">Video from UAS</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Settings</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Maps</a>
                        <ul class="dropdown-menu">
                            @foreach (var mappa in Maps)
                            {
                                <li><a class="dropdown-item" href="#" onclick="changeMap('@mappa.Trim()',activeTab)">@mappa.Trim()</a></li>
                            }
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb" id="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
            </ol>
        </nav>

        <!-- Nav-tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <!-- TAB Menù 1° Livello: Risk Analysis-->
            <!-- TAB Menù 2° Livello: Damages -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="buildings-tab" data-bs-toggle="tab" data-bs-target="#buildings" type="button" role="tab" aria-controls="buildings" aria-selected="false">Buildings</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="infrastructures-tab" data-bs-toggle="tab" data-bs-target="#infrastructures" type="button" role="tab" aria-controls="infrastructures" aria-selected="false">Critical Infrastructures</button>
            </li>

            <!-- TAB Menù 2° Livello: Resilience -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="social-tab" data-bs-toggle="tab" data-bs-target="#social" type="button" role="tab" aria-controls="social" aria-selected="false">Social Resilience</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="economic-tab" data-bs-toggle="tab" data-bs-target="#economic" type="button" role="tab" aria-controls="economic" aria-selected="false">Economic Resilience</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="operational-tab" data-bs-toggle="tab" data-bs-target="#operational" type="button" role="tab" aria-controls="operational" aria-selected="false">Operational Resilience</button>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content" id="myTabContent">
            <!-- TAB content Menù 1° Livello: Risk Analysis-->
            <!-- TAB content Menù 2° Livello: Damages -->
            <div class="tab-pane fade" id="buildings" role="tabpanel" aria-labelledby="buildings-tab">
                <!-- Content for Buildings tab -->
                <p>Content related to Buildings</p>
                <!-- Mappa Buildings -->
                <div id="mapBuildings" style="width: 100%; height: 100vh; cursor: pointer; overflow: hidden; display: block;"></div>
            </div>
            <div class="tab-pane fade" id="infrastructures" role="tabpanel" aria-labelledby="infrastructures-tab">
                <!-- Content for Critical Infrastructures tab -->
                <p>Content related to Critical Infrastructures</p>
                <!-- Mappa Critical Infrastructures-->
                <div id="mapCriticalInfrastructures" style="width: 100%; height: 100vh; cursor: pointer; overflow: hidden; display: block;"></div>
            </div>

            <!-- TAB content Menù 2° Livello: Resilience -->
            <div class="tab-pane fade" id="social" role="tabpanel" aria-labelledby="social-tab">
                <!-- Content for Social Resilience tab -->
                <p>Content related to Social Resilience</p>
                <!-- Mappa Social Resilience -->
                <div id="mapSocialResilience" style="width: 100%; height: 100vh; cursor: pointer; overflow: hidden; display: block;"></div>
            </div>
            <div class="tab-pane fade" id="economic" role="tabpanel" aria-labelledby="economic-tab">
                <!-- Content for Economic Resilience tab -->
                <p>Content related to Economic Resilience</p>
                <!-- Mappa Economic Resilience -->
                <div id="mapEconomicResilience" style="width: 100%; height: 100vh; cursor: pointer; overflow: hidden; display: block;"></div>
            </div>
            <div class="tab-pane fade" id="operational" role="tabpanel" aria-labelledby="operational-tab">
                <!-- Content for Operational Resilience tab -->
                <p>Content related to Operational Resilience</p>
                <!-- Mappa Operational Resilience -->
                <div id="mapOperationalResilience" style="width: 100%; height: 100vh; cursor: pointer; overflow: hidden; display: block;"></div>
            </div>

        </div>

        <!-- Barra di ricerca indirizzi -->
        <div class="search-bar">
            <div class="input-group">
                <input id="addressInput" placeholder="Cerca un indirizzo" type="text" class="form-control" style="text-overflow: ellipsis;">
            </div>
            <div id="suggestions" class="list-group mt-1" style="display: none;"></div>
        </div>

        <!-- Coordinate del mouse -->
        <div id="mouseCoordinates"></div>

        <script type="text/javascript">
            $(document).ready(function () {
                let centerLatitude = 13.1996
                let centerLongitude = 43.1167
                let zoomValue = 9

                mapBuildings = initWMSMap('mapBuildings', 'OpenStreetMap - EPSG:3857', centerLatitude, centerLongitude, zoomValue, '@ViewData["wmsurl1"]', '@ViewData["wmslayer1"]');
                mapCriticalInfrastructures = initWMSMap('mapCriticalInfrastructures', 'Google Normal - EPSG:3857', centerLatitude, centerLongitude, zoomValue, '@ViewData["wmsurl2"]', '@ViewData["wmslayer2"]');
                mapSocialResilience = initWMSMap('mapSocialResilience', 'OpenStreetMap - EPSG:3857', centerLatitude, centerLongitude, zoomValue, '@ViewData["wmsurl3"]', '@ViewData["wmslayer3"]',);
                mapEconomicResilience = initWMSMap('mapEconomicResilience', 'OpenStreetMap - EPSG:3857', centerLatitude, centerLongitude, zoomValue, '@ViewData["wmsurl4"]', '@ViewData["wmslayer4"]');
                mapOperationalResilience = initWMSMap('mapOperationalResilience', 'OpenStreetMap - EPSG:3857', centerLatitude, centerLongitude, zoomValue, 'https://ahocevar.com/geoserver/wms', 'topp:states');

                initTabs();
                updateTabs('Damages');
                updateBreadcrumb('Risk Analysis', 'Damages');
                
                $('#buildings-tab').on('click', function () {                   
                    activeTab = 'buildings';
                    console.log('activeTab =  buildings');
                });

                $('#infrastructures-tab').on('click', function () {
                    activeTab = 'infrastructures';
                    console.log('activeTab =  infrastructures');
                });

                $('#social-tab').on('click', function () {
                    activeTab = 'social';
                    console.log('activeTab =  social');
                });

                $('#economic-tab').on('click', function () {
                    activeTab = 'economic';
                    console.log('activeTab =  economic');
                });

                $('#operational-tab').on('click', function () {
                    activeTab = 'operational';
                    console.log('activeTab =  operational');
                });

                var lastInputTime = 0;
                var delay = 2000; // Delay di 2 secondi

                // Funzione per cercare gli indirizzi e visualizzare i suggerimenti
                $('#addressInput').on('input', function () {
                    var currentTime = new Date().getTime();
                    if (currentTime - lastInputTime > delay) {
                        lastInputTime = currentTime;
                        var address = $(this).val();

                        var url = 'https://nominatim.openstreetmap.org/search?q=' + address + '&format=json&addressdetails=1&limit=5';

                        $.getJSON(url, function (data) {
                            $('#suggestions').empty();
                            if (data && data.length > 0) {
                                $('#suggestions').show();
                                $.each(data, function (i, item) {
                                    $('#suggestions').append('<a href="#" class="list-group-item list-group-item-action" data-type="' + item.type + '" data-lon="' + item.lon + '" data-lat="' + item.lat + '">' + item.display_name + '</a>');
                                });
                            } else {
                                $('#suggestions').hide();
                            }
                        });
                    }
                });

                // Funzione per zoomare sulla posizione selezionata dall'utente
                $('#suggestions').on('click', 'a', function (e) {
                    e.preventDefault();
                    var address = $(this).text();
                    var type = $(this).data('type');
                    var url = 'https://nominatim.openstreetmap.org/search?q=' + address + '&format=json&addressdetails=1&limit=1';

                    $.getJSON(url, function (data) {
                        if (data && data.length > 0) {
                            var lon = parseFloat(data[0].lon);
                            var lat = parseFloat(data[0].lat);

                            let map;

                            map = getMapFromActiveTab(activeTab, map);
                            map.getView().setCenter(ol.proj.fromLonLat([lon, lat]));
                            map.getView().setZoom(15);

                            addPointer(lon, lat, activeTab);

                            $('#suggestions').hide();
                        }
                    });
                });

                // Funzione per gestire la selezione della mappa quando si fa clic su una delle voci del menu a discesa
                $('.dropdown-item').on('click', function () {
                    $('.dropdown-menu').removeClass('show');
                });

            });
        </script>
    </body>
    </html>
}